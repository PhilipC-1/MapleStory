<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è£œå“ç”Ÿå­˜æ¨¡æ“¬å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    /* === æ•´é«”è¨­å®š === */
    body {
      font-family: "Segoe UI", sans-serif;
      font-weight: bold;
      background: #e0f7fa;
      padding: 20px;
      font-size: 24px;
    }
    h1 {
      font-size: 36px;
      color: black;
      margin-bottom: 16px;
      text-align: center;
    }
    .section {
      width: max-content;
      margin: auto;
      margin-bottom: 10px;
    }

    /* === æ‰€æœ‰æ ¼å­ === */
    input,
    select {
      font-size: 20px;
      font-weight: bold;
      padding: 6px;
      border-radius: 5px;
      border: 3px solid black;
      box-sizing: border-box;
      text-align: center;
      width: 100px;
      max-width: 100px;
    }

    /* Readonly è‡ªå‹•è¼¸å‡ºæ¬„ä½ */
    input[readonly] {
      background: #f0f0f0;
      border: 3px dashed #383535;
      font-weight: bold;
    }

    /* === è¡¨å–®ç¾¤çµ„æ’ç‰ˆï¼ˆæ©«å‘ï¼‰ === */
    .input-group {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: nowrap;
      gap: 3px;
      margin-bottom: 15px;
    }

    /* Label æ¨™é¡Œ å°é½Šèˆ‡å¯¬åº¦ */
    .input-group label,
    .label-cell {
      font-size: 20px;
      color: black;
      white-space: nowrap;
    }
    .label-cell {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      min-width: 180px;
      max-width: 180px;
      gap: 3px;
    }

    .input-group.skill .label-cell {
      min-width: 100px !important;
      max-width: 120px !important;
      justify-content: flex-start !important;
      padding-left: 4px !important;
      color: #0288d1 !important;
    }

    /* é•· labelï¼ˆå¦‚ï¼šMPæ¸›å…æ¬„ï¼‰ */
    .label-cell.long-label {
      min-width: 140px;
      max-width: 140px;
    }

    /* å³å´ input æ¬„ä½ */
    .input-cell {
      min-width: 100px;
      max-width: 100px;
      text-align: center;
    }

    /* === å°ˆå±¬é¡è‰²è¨­å®š === */
    #maxHP, #hpDamage, #hpHealAmount, #finalHP, #actualHPDamage, #effectiveHealRatioHP {
      color: red;
    }
    #maxMP, #finalMP, #mpDamage, #actualMPDamage, #mpExpectedUsage, #effectiveHealRatioMP, #mpHealAmount {
      color: #007bff;
    }
    #mpReductionRate, #magicGuardLevel {
      color: #0288d1;
    }
    #monsterDamage, #finalMonsterDamage, #magicResistance, #forceReduce {
      color: #b266ff;
    }

    /* === å»ºè­°æ¬„ä½æ¨£å¼ === */
    #hpSuggest {
      background: #f0f0f0;
      border: 3px dashed #999999;
      color: red;
      font-weight: bold;
      max-width: 100px;
      width: auto;
      text-align: center;
    }
    .label-cell.suggestion {
      max-width: 80px;
      min-width: 50px;
      margin-left: 30px;
      text-align: center;
    }

    /* === æ»‘æ¢æ¨£å¼ === */
    .range-container-wrapper {
      width: 140px;
      display: flex;
      justify-content: center;
    }
    .range-container {
      position: relative;
      width: 140px;
      height: 35px;
      border-radius: 10px;
      background: white;
      border: 3px solid black;
      overflow: hidden;
      cursor: pointer;
    }
    .range-bar-bg {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 50%;
      background-color: red;
      border-radius: 8px;
      z-index: 1;
    }
    .range-container.blue .range-bar-bg {
      background-color: #007bff;
    }
    .range-thumb {
      position: absolute;
      top: 2px;
      left: calc(50% - 7px);
      width: 14px;
      height: 30px;
      background: black;
      border-radius: 7px;
      z-index: 3;
    }
    .range-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: bold;
      color: black;
      z-index: 4;
      pointer-events: none;
    }
    .range-container input[type="range"] {
      display: none;
    }

    /* æ»‘æ¢å®¹å™¨å¯¬åº¦å¾®èª¿ */
    #hpRangeWrapper, #mpRangeWrapper {
      width: 120px;
    }

    /* === Checkbox å®¢è£½æ¨£å¼ === */
    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 20px;
      margin: 0 10px;
      gap: 4px;
    }
    .checkbox-label input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin: 0;
      padding: 0;
      appearance: none;
      border: 3px solid black;
      border-radius: 6px;
      background-color: white;
      cursor: pointer;
      position: relative;
    }
    .checkbox-label input[type="checkbox"]:checked::after {
      content: "";
      position: absolute;
      left: 4.5px;
      top: 0px;
      width: 7px;
      height: 14px;
      border: solid black;
      border-width: 0 3px 3px 0;
      transform: rotate(45deg);
    }

    #statusContainer {
      width: 1000px;
      margin: 0 auto 10px auto;
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      font-size: 18px;
      color: #333;
    }

    /* === åœ–è¡¨èˆ‡ç´€éŒ„ === */
    #chartContainer {
      position: relative;
      max-width: 1650px;
      width: 100%;
      height: 400px;
      margin: 0 auto;
      overflow-x: auto;
    }
    #chart {
      width: 100% !important;
      height: 100% !important;
    }
    #logArea {
      background: #fff;
      padding: 5px;
      font-family: monospace;
      border-radius: 8px;
      margin: 10px auto; /* â† åŠ é€™è¡Œå¯ç½®ä¸­ */
      margin-top: 10px;
      height: 300px;
      width: 1000px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 16px;
      border: 1px solid #ccc;

    }
    .log-attack { color: #b266ff; }
    .log-heal { color: green; }
    .log-death { color: #555; }

    /* === HP / è£œå“å‹•ç•«æ¢ === */
    #hpBar, #cooldownBar {
      width: 500px;
      height: 18px;
      background: #ccc;
      border-radius: 10px;
      overflow: hidden;
      margin: 5px auto;
    }
    #hpFill, #cooldownFill {
      height: 24px;          /* é«˜åº¦èª¿å¤§ */
      width: 0%;             /* å¯¬åº¦éš¨ç‹€æ…‹è®Šå‹• */
      background-color: red; /* hpFillä¾‹ */
      transition: width 0.3s ease;
      border-radius: 6px;
    }

    #hpFill {
      height: 100%;
      background: red;
      transition: width 0.3s;
    }
    #cooldownFill {
      height: 16px;
      background: green;
      transition: width 0.3s;
    }

    /* === å¢“ç¢‘å‹•ç•« === */
    #tombstone {
      width: 80px;
      position: absolute;
      top: 0px; /* åŠ ä¸Šé€™è¡Œ */
      left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 999;
      transition: top 2s ease-in;
    }

    /* === æŒ‰éˆ•æ¨£å¼ === */
    button {
      padding: 10px 18px;
      font-size: 18px;
      border-radius: 6px;
      font-weight: bold;
      background: #0288d1;
      color: white;
      border: none;
      cursor: pointer;
      margin: 0 5px;
    }
    button:hover {
      background: #0277bd;
    }

    button#pauseBtn {
      background-color: #4caf50; /* ç¶ è‰² */
    }
    button#pauseBtn:hover {
      background-color: #388e3c;
    }

    button#resetBtn {
      background-color: #ffcc80; /* æ·¡æ©˜è‰² */
      color: black;
    }
    button#resetBtn:hover {
      background-color: #ffb74d;
    }

    /* === ç¦ç”¨æ•¸å­—æ¬„ä¸Šä¸‹ç®­é ­ï¼ˆç¾è§€ç”¨ï¼‰ === */
    /* Chrome/Safari */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    /* Firefox */
    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body>
  <h1>è£œå“ç”Ÿå­˜æ¨¡æ“¬å™¨</h1>
  <div class="section" id="app">
    <!-- æŠ€èƒ½å€ -->
    <div class="input-group skill">
      <label class="checkbox-label">
        <input type="checkbox" id="sacredFire" />
        <img src="https://maple.yampiz.com/maple/custom/skill/sk_02067.png" class="icon" />è–ç«
      </label>
      <label class="checkbox-label">
        <input type="checkbox" id="magicGuard" />
        <img src="https://maple.yampiz.com/maple/custom/skill/sk_01009.png" class="icon" />é­”å¿ƒé˜²ç¦¦
      </label>
      <label class="label-cell" style="color: #0288d1;">é­”å¿ƒé˜²ç¦¦ç­‰ç´š</label>
      <select id="magicGuardLevel" style="width: auto; font-weight: bold;">
        <!-- LV1 ~ LV20 -->
        <option>LV1</option><option>LV2</option><option>LV3</option><option>LV4</option>
        <option>LV5</option><option>LV6</option><option>LV7</option><option>LV8</option>
        <option>LV9</option><option>LV10</option><option>LV11</option><option>LV12</option>
        <option>LV13</option><option>LV14</option><option>LV15</option><option>LV16</option>
        <option>LV17</option><option>LV18</option><option>LV19</option><option>LV20</option>
      </select>
      <label class="label-cell" style="color: #0288d1;">MPæ›¿ä»£ç‡</label>
      <input id="mpReductionRate" readonly style="width: 70px; font-weight: bold; color: #0288d1" />
    </div>

    <!-- é­”æ³•æŠµæŠ—èˆ‡åŠ›é‡æ¶ˆé™¤ -->
    <div class="input-group">
      <label class="label-cell">
        <img src="https://maple.yampiz.com/maple/custom/skill/sk_03012.png" class="icon" />
        é­”æ³•æŠµæŠ—æ¸›å…%
      </label>
      <input id="magicResistance" type="number" value="0" />
      <label class="label-cell">
        <img src="https://maple.yampiz.com/maple/custom/skill/sk_03080.png" class="icon" />
        åŠ›é‡æ¶ˆé™¤æ¸›å…%
      </label>
      <input id="forceReduce" type="number" value="0" />
    </div>

    <!-- æœ€å¤§HP / æœ€çµ‚HP -->
    <div class="input-group">
      <label class="label-cell">æœ€å¤§HP</label>
      <input id="maxHP" type="number" value="4500" />
      <label class="label-cell">æœ€çµ‚HP</label>
      <input id="finalHP" readonly />
    </div>

    <!-- æœ€å¤§MP / æœ€çµ‚MP -->
    <div class="input-group">
      <label class="label-cell">æœ€å¤§MP</label>
      <input id="maxMP" type="number" value="5000" />
      <label class="label-cell">æœ€çµ‚MP</label>
      <input id="finalMP" readonly />
    </div>

    <!-- æ€ªç‰©å‚·å®³ -->
    <div class="input-group">
      <label class="label-cell">æ€ªç‰©æœ€å¤§å‚·å®³</label>
      <input id="monsterDamage" type="number" value="1900" />
      <label class="label-cell">æ€ªç‰©æ¸›å…å¾Œå‚·å®³</label>
      <input id="finalMonsterDamage" readonly />
    </div>

    <!-- é ä¼°æè€— -->
    <div class="input-group">
      <label class="label-cell">HPé ä¼°æè€—</label>
      <input id="hpDamage" readonly />
      <label class="label-cell">MPé ä¼°æè€—</label>
      <input id="mpDamage" readonly />
    </div>

    <!-- å¯¦éš›æè€— -->
    <div class="input-group">
      <label class="label-cell">HPå¯¦éš›æè€—</label>
      <input id="actualHPDamage" readonly />
      <label class="label-cell">MPå¯¦éš›æè€—</label>
      <input id="actualMPDamage" readonly />
    </div>

    <!-- ç„¡æ•µæ™‚é–“ MP é ä¼°ä½¿ç”¨ -->
    <div class="input-group" style="justify-content: center;">
      <label class="label-cell long-label">å–®æ¬¡ç„¡æ•µæ™‚é–“å…§MPé ä¼°ä½¿ç”¨é‡</label>
      <input id="mpExpectedUsage" type="number" value="0" />
    </div>

    <!-- HPè£œå“ -->
    <div class="input-group hp">
      <!-- 1. HPè£œå“å›å¾©é‡æ¨™ç±¤ -->
      <div class="label-cell">
        <img src="https://maple.yampiz.com/maple/custom/item/potion/po_in001.png" class="icon" />
        HPè£œå“å›å¾©é‡
      </div>

      <!-- 2. HPè£œå“å›å¾©é‡è¼¸å…¥æ¡† -->
      <input id="hpHealAmount" type="number" value="1000" />

      <!-- 3. å¯µè£œHPè¨­å®š% æ¨™ç±¤ -->
      <div class="label-cell">å¯µè£œHPè¨­å®š%</div>

      <!-- 4. å¯µè£œHPè¨­å®š% æ»‘æ¢ -->
      <div class="input-cell">
        <div class="range-container" id="hpRangeWrapper">
          <div class="range-bar-bg" id="hpBarBg"></div>
          <div class="range-thumb" id="hpThumb"></div>
          <span class="range-value" id="hpSliderValue">50%</span>
          <input type="range" id="hpPetSlider" min="0" max="100" value="50" />
        </div>
      </div>

      <!-- 5. å»ºè­°æ¬„ -->
      <div class="label-cell suggestion">å»ºè­°</div>
      <input id="hpSuggest" readonly value="30%" />
    </div>

    <!-- MPè£œå“ -->
    <div class="input-group mp">
      <!-- ç¬¬ä¸€åˆ—ï¼šåœ–ç¤º + å›å¾©é‡æ¬„ä½ -->
      <div class="label-cell">
        <img src="https://maple.yampiz.com/maple/custom/item/potion/po_in004.png" class="icon" />
        MPè£œå“å›å¾©é‡
      </div>
      <input id="mpHealAmount" type="number" value="300" />

      <!-- ç¬¬äºŒåˆ—ï¼šå¯µè£œ% æ»‘æ¢ -->
      <div class="label-cell">å¯µè£œMPè¨­å®š%</div>
      <div class="input-cell">
        <div class="range-container blue" id="mpRangeWrapper">
          <div class="range-bar-bg" id="mpBarBg"></div>
          <div class="range-thumb" id="mpThumb"></div>
          <span class="range-value" id="mpSliderValue">50%</span>
          <input type="range" min="0" max="100" value="50" id="mpPetSlider" />
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <button onclick="simulate()">é–‹å§‹æ¨¡æ“¬</button>
    <button onclick="play()">æ’­æ”¾å‹•ç•«</button>
    <button id="pauseBtn" onclick="pause()">æš«åœ</button>
    <button id="resetBtn" onclick="reset()">é‡ç½®</button>
    <!-- æœ€å¾ŒåŠ å…¥çš„hpStatuså’ŒcooldownStatus -->
    <div style="margin-top: 10px;">
      <span id="hpStatus"></span><br />
      <span id="cooldownStatus"></span>
    </div>
    <!-- è£œå“è¡€æ¢ -->
    <div id="hpBar"><div id="hpFill"></div></div>
    <div id="cooldownBar"><div id="cooldownFill"></div></div>
  </div>

  <div id="chartContainer" class="section">
    <canvas id="chart"></canvas>
  </div>

  <div id="logArea" class="section"></div>

  <img id="tombstone" src="https://upload.wikimedia.org/wikipedia/commons/4/47/Gravestone_Icon.png" alt="å¢“ç¢‘" />

  <script>
    window.onload = function () {
      // æŠŠé€™å››å€‹è®Šæ•¸è®Šæˆ window å…¨åŸŸå±¬æ€§
      window.chart = null;
      window.fullData = [];
      window.animationTimer = null;
      window.currentIndex = 0;

      const hpSlider = document.getElementById('hpPetSlider');
      const hpSliderValue = document.getElementById('hpSliderValue');
      const hpBarBg = document.getElementById('hpBarBg');
      const hpThumb = document.getElementById('hpThumb');
      const hpRangeWrapper = document.getElementById('hpRangeWrapper');

      let isDragging = false;

      function updateHPBar(clientX) {
        const rect = hpRangeWrapper.getBoundingClientRect();
        const percent = Math.min(
          Math.max(0, (clientX - rect.left) / rect.width),
          1,
        );
        const value = Math.round(percent * 100);

        hpSlider.value = value;
        hpSliderValue.textContent = value + '%';
        hpBarBg.style.width = value + '%';
        hpThumb.style.left = `calc(${value}% - 6px)`;
      }

      hpRangeWrapper.addEventListener('mousedown', function (e) {
        isDragging = true;
        updateHPBar(e.clientX);
      });

      window.addEventListener('mousemove', function (e) {
        if (isDragging) {
          updateHPBar(e.clientX);
        }
      });

      window.addEventListener('mouseup', function () {
        isDragging = false;
      });

      const mpSlider = document.getElementById('mpPetSlider');
      const mpSliderValue = document.getElementById('mpSliderValue');
      const mpBarBg = document.getElementById('mpBarBg');
      const mpThumb = document.getElementById('mpThumb');
      const mpRangeWrapper = document.getElementById('mpRangeWrapper');

      let isDraggingMP = false;

      function updateMPBar(clientX) {
        const rect = mpRangeWrapper.getBoundingClientRect();
        const percent = Math.min(
          Math.max(0, (clientX - rect.left) / rect.width),
          1,
        );
        const value = Math.round(percent * 100);

        mpSlider.value = value;
        mpSliderValue.textContent = value + '%';
        mpBarBg.style.width = value + '%';
        mpThumb.style.left = `calc(${value}% - 7px)`;
      }

      mpRangeWrapper.addEventListener('mousedown', function (e) {
        isDraggingMP = true;
        updateMPBar(e.clientX);
      });

      window.addEventListener('mousemove', function (e) {
        if (isDraggingMP) {
          updateMPBar(e.clientX);
        }
      });

      window.addEventListener('mouseup', function () {
        isDraggingMP = false;
      });

      // ==== ä»¥ä¸‹æ˜¯è‡ªå‹•è¨ˆç®—é‚è¼¯ ====
      function updateAll() {
        const sacredFire = document.getElementById('sacredFire').checked;
        const magicGuard = document.getElementById('magicGuard').checked;
        const magicGuardLevel =
          parseInt(
            document.getElementById('magicGuardLevel').value.replace('LV', ''),
          ) || 1;
        const maxHP = parseFloat(document.getElementById('maxHP').value) || 0;
        const maxMP = parseFloat(document.getElementById('maxMP').value) || 0;
        const monsterDamage =
          parseFloat(document.getElementById('monsterDamage').value) || 0;
        const magicResist =
          parseFloat(document.getElementById('magicResistance').value) / 100 || 0;
        const forceReduce =
          parseFloat(document.getElementById('forceReduce').value) / 100 || 0;
        const hpHealAmount =
          parseFloat(document.getElementById('hpHealAmount').value) || 0;
        const mpHealAmount =
          parseFloat(document.getElementById('mpHealAmount').value) || 0;
        const mpExpectedUsage =
          parseFloat(document.getElementById('mpExpectedUsage').value) || 0;

        const mpRate = magicGuard ? (20 + magicGuardLevel * 3) / 100 : 0;
        document.getElementById('mpReductionRate').value =
          Math.round(mpRate * 100) + '%';

        const finalHP = sacredFire ? maxHP * 1.6 : maxHP;
        const finalMP = sacredFire ? maxMP * 1.6 : maxMP;
        document.getElementById('finalHP').value = Math.round(finalHP);
        document.getElementById('finalMP').value = Math.round(finalMP);

        const finalMonsterDamage = Math.max(
          0,
          monsterDamage * (1 - magicResist) * (1 - forceReduce),
        );
        document.getElementById('finalMonsterDamage').value =
          Math.round(finalMonsterDamage);

        const hpDamage = finalMonsterDamage * (1 - mpRate);
        document.getElementById('hpDamage').value = Math.round(hpDamage);

        const mpDamage = finalMonsterDamage * mpRate;
        document.getElementById('mpDamage').value = Math.round(mpDamage);

        let actualMP = 0;
        if (magicGuard) {
          const mpRemain = mpHealAmount - mpExpectedUsage;
          actualMP = mpRemain <= mpDamage ? mpRemain : mpDamage;
          if (actualMP < 0) actualMP = 0;
        }
        document.getElementById('actualMPDamage').value = Math.round(actualMP);

        const actualHP = finalMonsterDamage - actualMP;
        document.getElementById('actualHPDamage').value = Math.round(actualHP);

        let hpSuggestRatio = 0;
        if (finalHP - hpHealAmount >= actualHP) {
          hpSuggestRatio = (finalHP - hpHealAmount) / finalHP;
        } else {
          hpSuggestRatio = actualHP / finalHP;
        }
        const rawPercent = Math.round(hpSuggestRatio * 100);
        document.getElementById('hpSuggest').value =
          Math.min(100, rawPercent) + '%';
      }

      // ç¶å®šè¼¸å…¥è§¸ç™¼
      const inputs = document.querySelectorAll('input, select');
      inputs.forEach((el) => el.addEventListener('input', updateAll));
      inputs.forEach((el) => el.addEventListener('change', updateAll));
      document.getElementById('sacredFire').addEventListener('change', updateAll);
      document.getElementById('magicGuard').addEventListener('change', updateAll);

      updateAll();

      // ä»¥ä¸‹å‡½å¼æ›åˆ° window æ–¹ä¾¿å¤–éƒ¨å‘¼å«
      window.simulate = function () {
        if (window.chart && typeof window.chart.destroy === 'function') {
          window.chart.destroy();
          window.chart = null;
        }
        updateAll();

        window.currentIndex = 0;
        window.fullData = [];

        const finalHP = +document.getElementById('finalHP').value || 1000;
        const inputDamage = +document.getElementById('actualHPDamage').value;
        const inputHeal = +document.getElementById('hpHealAmount').value;
        const petHealPercent = +document.getElementById('hpPetSlider').value;
        const yAxisMax = Math.ceil(finalHP / 1000) * 1000;
        const yStep = 1000;

        let hp = finalHP,
          cd = 0,
          time = 0.0,
          nextAtk = 0.0;
        const interval = 0.5,
          totalTime = 30.0;
        // === æ¨¡æ“¬ä¸»ç¨‹å¼ï¼ˆsimulate å‡½å¼å…§éƒ¨ï¼‰ ===
        while (time <= totalTime) {
          let take = 0,
            give = 0;
          // å—å‚·åˆ¤å®šï¼ˆåœ¨æ”»æ“Šæ™‚é–“é»ï¼‰
          if (Math.abs(time - nextAtk) < 0.001) {
            take = inputDamage;
            nextAtk += 2.0;
          }

          const tempHP = hp - take;
          if (tempHP <= 0 && take > 0) {
            console.log('æ­»äº¡æ™‚é–“é»', time);
            window.fullData.push({
              time,
              hp: 0,
              damage: take,
              heal: 0,
              cooldown: cd,
            });
            break;
          }
          const healThreshold = finalHP * (petHealPercent / 100);
          const shouldHeal = tempHP < healThreshold && cd <= 0;

          // è£œè¡€é‚è¼¯ï¼ˆåªæœ‰éæ­»äº¡æ‰è£œï¼‰
          if (shouldHeal || time === 0) {
            give = inputHeal;
            cd = 1.5;
          }
          // æ‰£å®Œè¡€å†è£œè¡€
          hp = Math.min(finalHP, tempHP + give);
          window.fullData.push({
            time,
            hp,
            damage: take,
            heal: give,
            cooldown: cd
          });

          time += interval;
          cd = Math.max(0, cd - interval);
        }

        const ctx = document.getElementById('chart').getContext('2d');
        window.chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],  // ç©ºé™£åˆ—ï¼šæ’­æ”¾å‹•ç•«æ™‚æ‰åŠ 
            datasets: [
              {
                label: 'ç•¶å‰è¡€é‡',
                data: [],  // ç©ºé™£åˆ—ï¼šæ’­æ”¾å‹•ç•«æ™‚æ‰åŠ 
                borderColor: 'red',
                borderWidth: 2,
                stepped: true,
                fill: false,
                tension: 0,
                pointRadius: window.fullData.map((d, i) => i === 0 || d.hp !== window.fullData[i - 1].hp ? 6 : 0),
                pointBackgroundColor: 'red',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            interaction: {
              mode: 'nearest',
              intersect: false,
            },
            scales: {
              x: {
                title: { display: true, text: 'æ™‚é–“ (ç§’)' },
                type: 'linear',
                min: 0,
                max: window.fullData[window.fullData.length - 1].time,
                ticks: {
                  autoSkip: false,
                  callback: (v) => parseFloat(v).toFixed(1),
                  maxRotation: 0,
                  minRotation: 0,
                  stepSize: window.innerWidth < 800 ? 1 : 0.5,
                },
              },
              y: {
                title: { display: true, text: 'HP', rotation: 0 },
                min: 0,
                max: yAxisMax,
                ticks: {
                  stepSize: yStep,
                  callback: (v) => v.toLocaleString(),
                },
              },
            },
            plugins: {
              tooltip: {
                displayColors: false,
                titleFont: { size: 18 },
                bodyFont: { size: 18 },
                callbacks: {
                  title: (ctx) =>
                    'ç•¶å‰è¡€é‡: ' + window.fullData[ctx[0].dataIndex].hp,
                  label: (ctx) => {
                    const d = window.fullData[ctx.dataIndex];
                    let lines = [];
                    if (d.damage) lines.push('ğŸ©¸ -' + d.damage + ' HP');
                    if (d.heal) lines.push('ğŸ§ª +' + d.heal + ' HP');
                    return lines;
                  },
                },
              },
              datalabels: {
                display: (ctx) => {
                  const i = ctx.dataIndex;
                  const d = window.fullData[i];
                  return i === 0 || d.hp !== window.fullData[i - 1].hp;
                },
                align: 'top',
                color: 'red',
                font: { size: 16, weight: 'bold' },
                formatter: (_, ctx) => window.fullData[ctx.dataIndex].hp,
              },
            },
          },
          plugins: [ChartDataLabels],
        });

        window.updateXAxisTicks();

        document.getElementById('logArea').textContent = '';
        document.getElementById('tombstone').style.display = 'none';
        document.getElementById('tombstone').style.top = '0px';
        currentIndex = 0;
        window.updateStatus(0);
      };

      window.play = function () {
        if (!window.fullData.length || window.animationTimer) return;

        window.animationTimer = setInterval(() => {
          if (window.currentIndex >= window.fullData.length) {
            clearInterval(window.animationTimer);
            window.animationTimer = null;
            return;
          }

          window.chart.data.labels = window.fullData
            .slice(0, window.currentIndex + 1)
            .map((d) => d.time.toFixed(1));
          window.chart.data.datasets[0].data = window.fullData
            .slice(0, window.currentIndex + 1)
            .map((d) => d.hp);
          window.chart.update('none');

          const d = window.fullData[window.currentIndex];
          const log = document.getElementById('logArea');
          if (d.damage)
            log.innerHTML += `<div class="log-attack">ğŸ©¸ [${d.time.toFixed(1)}s] å—åˆ°æ”»æ“Š -${d.damage} HP</div>`;
          if (d.heal)
            log.innerHTML += `<div class="log-heal">ğŸ§ª [${d.time.toFixed(1)}s] ä½¿ç”¨è£œå“ +${d.heal} HP</div>`;
          if (d.hp === 0) {
            log.innerHTML += `<div class="log-death">â˜ ï¸ [${d.time.toFixed(1)}s] è§’è‰²æ­»äº¡</div>`;
            window.showTombstone();
            clearInterval(window.animationTimer);
            window.animationTimer = null;
          }

          window.updateStatus(window.currentIndex);
          window.currentIndex++;
        }, 500);
      };

      window.updateStatus = function (i) {
        const d = window.fullData[i];
        const finalHP = +document.getElementById('finalHP').value;
        document.getElementById('hpStatus').textContent = `ç•¶å‰HPï¼š${d.hp}`;
        document.getElementById('cooldownStatus').textContent =
          `è£œå“å†·å»ï¼š${d.cooldown?.toFixed(1) ?? 0}s`;
        document.getElementById('hpFill').style.width =
          (d.hp / finalHP) * 100 + '%';
        document.getElementById('cooldownFill').style.width =
          ((d.cooldown ?? 0) / 1.5) * 100 + '%';
      };

      window.pause = function () {
        if (window.animationTimer) {
          clearInterval(window.animationTimer);
          window.animationTimer = null;
        }
      };

      window.reset = function () {
        if (window.animationTimer) {
          clearInterval(window.animationTimer);
          window.animationTimer = null;
        }
        window.currentIndex = 0;
        if (window.chart) {
          window.chart.destroy();
          window.chart = null;
        }
        document.getElementById('logArea').textContent = '';
        document.getElementById('tombstone').style.display = 'none';
        document.getElementById('tombstone').style.top = '0px';
        document.getElementById('hpFill').style.width = '0%';
        document.getElementById('cooldownFill').style.width = '0%';
        document.getElementById('hpStatus').textContent = '';
        document.getElementById('cooldownStatus').textContent = '';
      };

      window.showTombstone = function () {
        const t = document.getElementById('tombstone');
        t.style.display = 'block';
        setTimeout(() => {
          t.style.top = '900px';
        }, 100);
      };

      window.updateXAxisTicks = function () {
        if (!window.chart) return;
        const step = window.innerWidth < 800 ? 1 : 0.5;
        window.chart.options.scales.x.ticks.stepSize = step;
        window.chart.update('none');
      };

      window.addEventListener('resize', window.updateXAxisTicks);
    };
  </script>
</body>
</html>
