<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è£œå“ç”Ÿå­˜æ¨¡æ“¬å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: bold;
      background: #e0f7fa;
      color: #000;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
      position: relative;
      min-height: 600px;
      user-select: none;
    }
    .dark-mode {
      background: #1e1e1e;
      color: #eee;
    }
    .input-group {
      margin-bottom: 20px;
    }
    .input-group label {
      font-size: 20px;
      display: block;
      margin-bottom: 4px;
      user-select: text;
    }
    .input-group input {
      font-size: 22px;
      font-weight: bold;
      padding: 10px;
      width: 200px;
      border-radius: 8px;
      user-select: text;
    }
    #maxHP { color: red; }
    #monsterDamage { color: #b266ff; }
    #healAmount { color: green; }
    button {
      padding: 10px 16px;
      font-size: 18px;
      font-weight: bold;
      margin: 5px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #0288d1, #03a9f4);
      color: white;
      user-select: none;
      transition: opacity 0.2s;
    }
    button:hover { opacity: 0.9; }
    #toggleMode { background: #555; color: #fff; }
    #hpValueText { font-size: 22px; color: red; margin-top: 10px; user-select: text; }
    #cooldownText { font-size: 20px; color: green; user-select: text; }
    #hpBarContainer {
      background: #ccc;
      border-radius: 10px;
      margin-top: 20px;
      position: relative;
      height: 30px;
      box-shadow: inset 0 0 6px #888;
      user-select: none;
    }
    #hpBar {
      background: #f44336;
      height: 100%;
      width: 100%;
      border-radius: 10px;
      transition: width 0.3s;
    }
    #cdBar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 12px;
      background: #4caf50;
      width: 0%;
      border-radius: 0 0 10px 10px;
      transition: width 0.1s linear;
    }
    #logArea {
      background: #fff;
      padding: 10px;
      font-family: monospace;
      margin-top: 20px;
      border-radius: 10px;
      height: 160px;
      overflow-y: auto;
      user-select: text;
      white-space: pre-wrap;
      color: #000;
    }
    .dark-mode #logArea {
      background: #333;
      color: #eee;
    }
    .log-attack { color: #b266ff; }
    .log-heal { color: green; }
    #tombstone {
      position: absolute;
      width: 80px;
      height: auto;
      right: -100px;
      top: -150px;
      transition: transform 1s ease-in, top 1s ease-in, opacity 1s ease-in;
      opacity: 0;
      pointer-events: none;
      user-select: none;
      z-index: 20;
    }
    .fall {
      top: 120px;
      right: 50%;
      transform: translateX(50%) rotate(10deg);
      opacity: 1;
    }
    /* tooltip style - ç°åº•ç™½å­—ï¼Œè²¼è¿‘é»ï¼Œç„¡é‚Šæ¡† */
    .chartjs-tooltip {
      opacity: 1;
      position: absolute;
      background: #444;
      color: #fff;
      border: none !important;
      pointer-events: none;
      padding: 6px 10px;
      font-size: 18px;
      font-weight: bold;
      white-space: pre-line;
      max-width: 280px;
      line-height: 1.3em;
      border-radius: 6px;
      user-select: none;
      transition: opacity 0.1s ease;
      z-index: 9999;
    }
    body.dark-mode .chartjs-tooltip {
      background: #222;
      color: #eee;
    }
  </style>
</head>
<body>
  <h1>è£œå“ç”Ÿå­˜æ¨¡æ“¬å™¨</h1>
  <div class="input-group"><label>æœ€å¤§è¡€é‡ï¼š</label><input id="maxHP" type="number" value="1000" min="1" /></div>
  <div class="input-group"><label>æ€ªç‰©æœ€å¤§å‚·å®³ï¼š</label><input id="monsterDamage" type="number" value="500" min="0" /></div>
  <div class="input-group"><label>è£œå“å›å¾©é‡ï¼š</label><input id="healAmount" type="number" value="300" min="0" /></div>

  <button onclick="simulate()">é–‹å§‹æ¨¡æ“¬</button>
  <button onclick="play()">æ’­æ”¾å‹•ç•«</button>
  <button onclick="pause()">æš«åœ</button>
  <button onclick="reset()">é‡æ’­</button>
  <button id="toggleMode" onclick="toggleMode()">åˆ‡æ›å¤œ/æ—¥æ¨¡å¼</button>

  <div id="hpValueText">ç•¶å‰HP: --</div>
  <div id="cooldownText">è£œå“å†·å»å€’æ•¸ï¼š--</div>

  <div id="hpBarContainer">
    <div id="hpBar"></div>
    <div id="cdBar"></div>
  </div>

  <canvas id="chart" width="1000" height="300"></canvas>
  <div id="logArea"></div>
  <img id="tombstone" src="tombstone.png" alt="å¢“ç¢‘" />

<script>
(() => {
  // å…¨åŸŸè®Šæ•¸
  let chart = null;
  let maxHP = 1000;
  let healTimes = new Set();
  let hitTimes = new Set();
  let fullLabels = [];
  let fullData = [];
  let interval = 0.5;
  let hitCD = 2.0;
  let healCD = 1.5;
  let timer = null;
  let index = 0;
  let isPaused = false;
  let currentHP = 0;
  let lastHealTime = -999;
  let logArea = null;
  let hpBar, cdBar, hpText, cdText, tombstone;

  // åˆå§‹åŒ–å…ƒç´ 
  function initElements() {
    logArea = document.getElementById('logArea');
    hpBar = document.getElementById('hpBar');
    cdBar = document.getElementById('cdBar');
    hpText = document.getElementById('hpValueText');
    cdText = document.getElementById('cooldownText');
    tombstone = document.getElementById('tombstone');
  }

  // æ¨¡æ“¬è¨ˆç®—
  function simulate() {
    clearInterval(timer);
    isPaused = false;
    index = 0;
    healTimes.clear();
    hitTimes.clear();
    fullLabels = [];
    fullData = [];
    lastHealTime = -999;
    logArea.textContent = '';

    maxHP = Number(document.getElementById('maxHP').value);
    const monsterDmg = Number(document.getElementById('monsterDamage').value);
    const healAmount = Number(document.getElementById('healAmount').value);

    let hp = maxHP;
    let t = 0;
    let nextHit = 0;

    while (t <= 30) {
      const tStr = t.toFixed(1);
      fullLabels.push(tStr);

      // æ€ªç‰©æ”»æ“Šåˆ¤æ–·
      if (t >= nextHit) {
        hp -= monsterDmg;
        nextHit += hitCD;
        hitTimes.add(tStr);
        logArea.innerHTML += `ğŸ©¸ [${tStr}s] å—åˆ°æ”»æ“Š -${monsterDmg} HP\n`;
      }

      // è£œå“è£œè¡€åˆ¤æ–·(æ ¹æ“šæ¢ä»¶)
      let threshold = (maxHP - healAmount > monsterDmg) ? (maxHP - healAmount) : monsterDmg;
      if (hp <= threshold && (t - lastHealTime >= healCD)) {
        hp += healAmount;
        if (hp > maxHP) hp = maxHP;
        lastHealTime = t;
        healTimes.add(tStr);
        logArea.innerHTML += `ğŸ’Š [${tStr}s] ä½¿ç”¨è£œå“ +${healAmount} HP\n`;
      }

      if (hp <= 0) {
        hp = 0;
        fullData.push(hp);
        break;
      }

      fullData.push(hp);
      t += interval;
    }

    currentHP = maxHP;
    updateBars(currentHP, 0);
    drawChart([], []);
    tombstone.classList.remove('fall');
  }

  // ç¹ªè£½åœ–è¡¨
  function drawChart(customLabels, customData) {
    const ctx = document.getElementById('chart').getContext('2d');
    if (chart) chart.destroy();

    const labelsToUse = customLabels.length > 0 ? customLabels : fullLabels;
    const dataToUse = customData.length > 0 ? customData : fullData;

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labelsToUse,
        datasets: [{
          label: 'HP',
          data: dataToUse,
          borderColor: '#f44336',
          backgroundColor: 'rgba(244,67,54,0.1)',
          stepped: true,
          borderWidth: 3,
          pointRadius: 10,
          pointHoverRadius: 14
        }]
      },
      options: {
        animation: false,
        responsive: true,
        plugins: {
          tooltip: {
            enabled: false,
            external: customTooltip
          },
          datalabels: {
            color: '#000',
            font: { weight: 'bold' },
            align: 'top',
            display: function(context) {
              const i = context.dataIndex;
              const d = context.chart.data.datasets[0].data;
              return i === 0 || d[i] !== d[i - 1];
            },
            formatter: function(value) {
              return value;
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'æ™‚é–“ï¼ˆç§’ï¼‰' } },
          y: { beginAtZero: true, max: maxHP + 50 }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  // è‡ªè¨‚ tooltip
  function customTooltip(context) {
  const tooltipEl = getOrCreateTooltip(context.chart);
  const tooltipModel = context.tooltip;

  if (tooltipModel.opacity === 0) {
    tooltipEl.style.opacity = 0;
    return;
  }

  const dataPointIndex = tooltipModel.dataPoints[0].dataIndex;
  const label = tooltipModel.dataPoints[0].label;
  const dataset = context.chart.data.datasets[0];
  const prevValue = dataPointIndex === 0 ? maxHP : dataset.data[dataPointIndex - 1];
  const currValue = dataset.data[dataPointIndex];
  const timeStr = label;

  // æ˜¯å¦æœ‰æ”»æ“Šèˆ‡è£œè¡€
  const isHit = hitTimes.has(timeStr);
  const isHeal = healTimes.has(timeStr);

  // åˆ†åˆ¥è¨ˆç®—å—å‚·èˆ‡è£œè¡€ï¼Œä¸åˆä½µ
  let damageAmount = 0;
  let healAmount = 0;

  if (isHit && currValue < prevValue) {
    damageAmount = prevValue - currValue;
  }
  if (isHeal && currValue > prevValue) {
    healAmount = currValue - prevValue;
  }

  // å¦‚æœå…©è€…éƒ½æ²’æœ‰ï¼Œéš±è—tooltip
  if (damageAmount === 0 && healAmount === 0) {
    tooltipEl.style.opacity = 0;
    return;
  }

  // å»ºç«‹å¤šè¡Œå…§å®¹ï¼Œä¸¦åŠ ä¸Šæ¨£å¼class
  let lines = [];
  if (damageAmount > 0) {
    lines.push(`<div class="log-attack" style="color:#b266ff;">ğŸ©¸ å—åˆ°æ”»æ“Š ${damageAmount} HP</div>`);
  }
  if (healAmount > 0) {
    lines.push(`<div class="log-heal" style="color:green;">ğŸ§ª ä½¿ç”¨è£œå“ +${healAmount} HP</div>`);
  }

  tooltipEl.innerHTML = lines.join('');

  // å–å¾—canvasé‚Šç•ŒåŠæ»‘é¼ é»ä½
  const canvasRect = context.chart.canvas.getBoundingClientRect();
  const caretX = tooltipModel.caretX;
  const caretY = tooltipModel.caretY;

  // æ°´å¹³ç½®ä¸­ï¼Œå‚ç›´åœ¨é»ä½ä¸Šæ–¹8px
  let left = canvasRect.left + caretX - tooltipEl.offsetWidth / 2;
  let top = canvasRect.top + caretY - tooltipEl.offsetHeight - 8;

  // é‚Šç•Œä¿®æ­£ï¼Œé˜²æ­¢è·‘å‡ºè¢å¹•
  if (left < 4) left = 4;
  if (left + tooltipEl.offsetWidth > window.innerWidth - 4) {
    left = window.innerWidth - tooltipEl.offsetWidth - 4;
  }
  if (top < 4) {
    top = canvasRect.top + caretY + 8; // ç©ºé–“ä¸å¤ æ™‚æ”¹æ”¾ä¸‹é¢8px
  }

  // è¨­å®štooltipä½ç½®èˆ‡é¡¯ç¤º
  tooltipEl.style.left = left + 'px';
  tooltipEl.style.top = top + 'px';
  tooltipEl.style.opacity = 1;
}

  function getOrCreateTooltip(chart) {
    let tooltipEl = chart.canvas.parentNode.querySelector('div.chartjs-tooltip');
    if (!tooltipEl) {
      tooltipEl = document.createElement('div');
      tooltipEl.classList.add('chartjs-tooltip');
      chart.canvas.parentNode.appendChild(tooltipEl);
    }
    return tooltipEl;
  }

  // æ›´æ–°è¡€é‡èˆ‡å†·å»æ¢
  function updateBars(hp, cdPercent) {
    hpBar.style.width = (hp / maxHP) * 100 + '%';
    hpText.textContent = `ç•¶å‰HP: ${hp}`;
    cdBar.style.width = cdPercent + '%';
    if(cdPercent <= 0){
      cdText.textContent = 'è£œå“å†·å»å€’æ•¸ï¼š0s';
    } else {
      let cdSeconds = (healCD * (100 - cdPercent) / 100).toFixed(1);
      cdText.textContent = `è£œå“å†·å»å€’æ•¸ï¼š${cdSeconds}s`;
    }
  }

  // å‹•ç•«æ’­æ”¾æ§åˆ¶
  function play() {
    if (timer) return;
    if (!fullLabels.length) return;

    isPaused = false;
    timer = setInterval(() => {
      if (isPaused) return;

      if (index >= fullLabels.length) {
        clearInterval(timer);
        timer = null;
        if(currentHP <= 0) showTombstone();
        return;
      }

      const tStr = fullLabels[index];
      const hp = fullData[index];
      currentHP = hp;

      let cdPercent = 0;
      let nextHealTime = null;
      for(let i = index; i < fullLabels.length; i++){
        if(healTimes.has(fullLabels[i])){
          nextHealTime = Number(fullLabels[i]);
          break;
        }
      }
      if(nextHealTime !== null){
        let diff = nextHealTime - Number(tStr);
        if(diff < healCD){
          cdPercent = (1 - diff / healCD) * 100;
          if(cdPercent < 0) cdPercent = 0;
          if(cdPercent > 100) cdPercent = 100;
        }
      }

      updateBars(hp, cdPercent);
      index++;
    }, interval * 1000);
  }

  function pause() {
    if(timer){
      isPaused = true;
    }
  }

  function reset() {
    clearInterval(timer);
    timer = null;
    index = 0;
    currentHP = maxHP;
    updateBars(maxHP, 0);
    tombstone.classList.remove('fall');
  }

  function toggleMode() {
    document.body.classList.toggle('dark-mode');
  }

  function showTombstone() {
    tombstone.classList.add('fall');
    console.log('å¢“ç¢‘å‹•ç•«è§¸ç™¼');
  }

  window.onload = () => {
    initElements();
    simulate();
  };

  window.simulate = simulate;
  window.play = play;
  window.pause = pause;
  window.reset = reset;
  window.toggleMode = toggleMode;
})();
</script>
</body>
</html>
